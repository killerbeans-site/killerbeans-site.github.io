<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">body{max-width:650px;margin:40px auto;padding:0 10px;font:18px/1.5 -apple-system,BlinkMacSystemFont,"avenir next",avenir,"Segoe UI","lucida grande","helvetica neue",helvetica,"Fira Sans",roboto,noto,"Droid Sans",cantarell,oxygen,ubuntu,"franklin gothic medium","century gothic","Liberation Sans",sans-serif;color:#444}h1,h2,h3{line-height:1.2}</style>
</head>
<body>

<script type="text/javascript">
let sleep = ms => {
	return new Promise(resolve => setTimeout(resolve, ms));
}

let request = obj => {
    return new Promise((resolve, reject) => {
        let xhr = new XMLHttpRequest();
        console.log(obj.url);
        xhr.open(obj.method || "GET", obj.url);
        if (obj.headers) {
            Object.keys(obj.headers).forEach(key => {
                xhr.setRequestHeader(key, obj.headers[key]);
            });
        }
        xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
                resolve(xhr.response);
            } else {
                reject(xhr.statusText);
            }
        };
        xhr.onerror = () => reject(xhr.statusText);
        xhr.send(obj.body);
    });
};

var getRatioInputs = async(charid, page) => {
	let raw = await request({"url": `https://zkillboard.com/api/characterID/${charid}/kills/pastSeconds/604800/page/${page}/`});
	let data = JSON.parse(raw);
	let out = data.reduce((acc, row) => {
		acc.sum += row.zkb.points;
		acc.count += 1;
		return acc;
	}, {"sum": 0, "count": 0});
	return out;
}

var getScore = async(charid) => {
	// let data = await request({"url": "https://zkillboard.com/api/characterID/2115421580/kills/pastSeconds/604800/"});
	let total = undefined;
	let page = 1;
	while (true) {
		let data = await getRatioInputs(charid, page++);
		if (data.count == 0) {
			break;
		}
		if (total !== undefined) {
			total.sum += data.sum;
			total.count = data.count;
		} else {
			total = data;
		}
		await sleep(2000);
	}
	console.log(total.sum / total.count);
	return [total.sum, total.count];
}

var buttonPressed = () => {
	let char_url = document.getElementById("inputUrl").value;
	console.log(char_url);
	console.log(char_url.match(/character\/(?<id>\d+)/));
	let char_id = char_url.match(/character\/(?<id>\d+)/).groups.id;
	window.setTimeout(async() => showScore(char_id), 10);
}

var showScore = async(charid) => {
	let display = document.getElementById("display");
	console.log("time to get score");
	let [sum, count] = await getScore(charid);
	let score = sum / count;
	score = Math.round(score * 100) / 100;

	let text = `${count} kills totaling ${sum} points => <b>${score}</b>`

	display.innerHTML = text;
}

// window.setTimeout(getKills 5000);
</script>
<p>
Paste in your character's zkill url:<br />
<input type="text" id="inputUrl" value="https://zkillboard.com/character/2115421580/" style="width:100%;" /><br />
<input type="submit" value="How elite am I?" onclick="buttonPressed()" /><br />
<span id="display"></span>
<aside>higher is better</aside>
</p>
</body>
</html>
